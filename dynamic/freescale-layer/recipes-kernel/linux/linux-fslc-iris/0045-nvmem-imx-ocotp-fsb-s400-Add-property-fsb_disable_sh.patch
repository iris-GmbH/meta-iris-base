From dd80ee614b52cffc7dc8fcf5c901d2811041cf0d Mon Sep 17 00:00:00 2001
From: Michael Glembotzki <Michael.Glembotzki@iris-sensing.com>
Date: Thu, 14 Aug 2025 09:57:01 +0000
Subject: [PATCH] nvmem: imx-ocotp-fsb-s400: Add property
 fsb_disable_shadowed_read

Add property fsb_disable_shadowed_read to disable fuse shadow register
read and enforce fuse sensing.

Upstream-Status: Inappropriate
Signed-off-by: Michael Glembotzki <Michael.Glembotzki@iris-sensing.com>
---
 arch/arm64/boot/dts/freescale/imx93-matrixup.dts | 5 +++++
 drivers/nvmem/imx-ocotp-fsb-s400.c               | 2 +-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/arch/arm64/boot/dts/freescale/imx93-matrixup.dts b/arch/arm64/boot/dts/freescale/imx93-matrixup.dts
index 38b1bdcfba9b9..f44fff75fe1a9 100644
--- a/arch/arm64/boot/dts/freescale/imx93-matrixup.dts
+++ b/arch/arm64/boot/dts/freescale/imx93-matrixup.dts
@@ -360,6 +360,11 @@ cap_device {
 	};
 };
 
+&aonmix_ns_gpr {
+	/* disable shadow register read to enforce fuse sensing */
+	fsb_disable_shadowed_read;
+};
+
 &parallel_csi {
 	#address-cells = <1>;
 	#size-cells = <0>;
diff --git a/drivers/nvmem/imx-ocotp-fsb-s400.c b/drivers/nvmem/imx-ocotp-fsb-s400.c
index 87e47df9b187d..bdcd5303fb885 100644
--- a/drivers/nvmem/imx-ocotp-fsb-s400.c
+++ b/drivers/nvmem/imx-ocotp-fsb-s400.c
@@ -380,7 +380,7 @@ static int imx_fsb_s400_fuse_probe(struct platform_device *pdev)
 			return -ENOMEM;
 
 		v = readl_relaxed(reg + FUSE_ACC_DIS);
-		if (v & BIT(0))
+		if (v & BIT(0) || of_property_read_bool(np, "fsb_disable_shadowed_read"))
 			fuse->fsb_read_dis = true;
 		else
 			fuse->fsb_read_dis = false;
-- 
2.44.4

