From 08e1986e578039be17688cc1086742b2e92771f5 Mon Sep 17 00:00:00 2001
From: Erik Schumacher <erik.schumacher@iris-sensing.com>
Date: Wed, 10 Apr 2024 11:13:26 +0200
Subject: [PATCH] media/imx: Add RAW8 and RAW10 format and default to RAW8

Upstream-Status: Pending

Signed-off-by: Erik Schumacher <erik.schumacher@iris-sensing.com>
---
 drivers/staging/media/imx/imx8-isi-cap.c      | 27 ++++++++++++++++---
 drivers/staging/media/imx/imx8-isi-fmt.c      | 18 +++++++++++++
 drivers/staging/media/imx/imx8-parallel-csi.c |  7 +++--
 3 files changed, 47 insertions(+), 5 deletions(-)

diff --git a/drivers/staging/media/imx/imx8-isi-cap.c b/drivers/staging/media/imx/imx8-isi-cap.c
index 76cf7d7f5745..a5cc1b8d394c 100644
--- a/drivers/staging/media/imx/imx8-isi-cap.c
+++ b/drivers/staging/media/imx/imx8-isi-cap.c
@@ -54,6 +54,20 @@ struct mxc_isi_fmt mxc_isi_src_formats[] = {
 		.memplanes	= 1,
 		.colplanes	= 1,
 		.align		= 2,
+	}, {
+		.name		= "RAW8",
+		.fourcc		= V4L2_PIX_FMT_GREY,
+		.depth		= { 8 },
+		.memplanes	= 1,
+		.colplanes	= 1,
+		.align		= 1,
+	}, {
+		.name		= "RAW10",
+		.fourcc		= V4L2_PIX_FMT_Y10,
+		.depth		= { 16 },
+		.memplanes	= 1,
+		.colplanes	= 1,
+		.align		= 2,
 	}
 };
 
@@ -93,15 +107,22 @@ struct mxc_isi_fmt *mxc_isi_get_src_fmt(struct v4l2_subdev_format *sd_fmt)
 	u32 index;
 
 	/* two fmt RGB32 and YUV444 from pixellink */
-	if (sd_fmt->format.code == MEDIA_BUS_FMT_YUYV8_1X16 ||
+	if (sd_fmt->format.code == MEDIA_BUS_FMT_Y10_1X10 ||
+		sd_fmt->format.code == MEDIA_BUS_FMT_SBGGR10_1X10) {
+		index = 3;
+	} else if (sd_fmt->format.code == MEDIA_BUS_FMT_Y8_1X8 ||
+		sd_fmt->format.code == MEDIA_BUS_FMT_SBGGR8_1X8) {
+		index = 2;
+	} else if (sd_fmt->format.code == MEDIA_BUS_FMT_YUYV8_1X16 ||
 	    sd_fmt->format.code == MEDIA_BUS_FMT_YVYU8_2X8 ||
 	    sd_fmt->format.code == MEDIA_BUS_FMT_AYUV8_1X32 ||
 	    sd_fmt->format.code == MEDIA_BUS_FMT_UYVY8_2X8 ||
 	    sd_fmt->format.code == MEDIA_BUS_FMT_UYVY8_1X16||
-	    sd_fmt->format.code == MEDIA_BUS_FMT_YUYV8_2X8)
+	    sd_fmt->format.code == MEDIA_BUS_FMT_YUYV8_2X8) {
 		index = 1;
-	else
+	} else {
 		index = 0;
+	}
 	return &mxc_isi_src_formats[index];
 }
 
diff --git a/drivers/staging/media/imx/imx8-isi-fmt.c b/drivers/staging/media/imx/imx8-isi-fmt.c
index db11c809a3d3..bb4880f31f5e 100644
--- a/drivers/staging/media/imx/imx8-isi-fmt.c
+++ b/drivers/staging/media/imx/imx8-isi-fmt.c
@@ -97,6 +97,24 @@ struct mxc_isi_fmt mxc_isi_out_formats[] = {
 		.colplanes	= 1,
 		.align		= 2,
 		.mbus_code	= MEDIA_BUS_FMT_RGB888_1X24,
+	}, {
+		.name		= "RAW8",
+		.fourcc		= V4L2_PIX_FMT_GREY,
+		.depth		= { 8 },
+		.color		= MXC_ISI_OUT_FMT_RAW8,
+		.memplanes	= 1,
+		.colplanes	= 1,
+		.align		= 1,
+		.mbus_code	= MEDIA_BUS_FMT_Y8_1X8,
+	}, {
+		.name		= "RAW10",
+		.fourcc		= V4L2_PIX_FMT_Y10,
+		.depth		= { 16 },
+		.color		= MXC_ISI_OUT_FMT_RAW10,
+		.memplanes	= 1,
+		.colplanes	= 1,
+		.align		= 2,
+		.mbus_code	= MEDIA_BUS_FMT_Y10_1X10,
 	}
 };
 
diff --git a/drivers/staging/media/imx/imx8-parallel-csi.c b/drivers/staging/media/imx/imx8-parallel-csi.c
index a25ef807b025..bf6d90b93faa 100644
--- a/drivers/staging/media/imx/imx8-parallel-csi.c
+++ b/drivers/staging/media/imx/imx8-parallel-csi.c
@@ -269,6 +269,9 @@ static void disp_mix_gasket_config(struct mxc_parallel_csi_dev *pcsidev)
 
 	regmap_read(gasket, DISP_MIX_CAMERA_MUX, &val);
 	val |= (SRC_TYPE_PARALLEL << 17);
+	val |= DISP_MIX_CAMERA_MUX_GASKET_ENABLE;
+	val &= ~(DISP_MIX_CAMERA_MUX_DATA_TYPE(0xff));
+	val |= DISP_MIX_CAMERA_MUX_DATA_TYPE(0x2a); // 0x2a = RAW8, 0x2b = RAW10
 	regmap_write(gasket, DISP_MIX_CAMERA_MUX, val);
 }
 
@@ -372,7 +375,7 @@ static void mxc_pcsi_csr_config(struct mxc_parallel_csi_dev *pcsidev)
 
 	/* Config PL Data Type */
 	val = readl(pcsidev->csr_regs + pdata->if_ctrl_reg);
-	val |= IF_CTRL_REG_DATA_TYPE(DATA_TYPE_OUT_YUV444);
+	val |= IF_CTRL_REG_DATA_TYPE(DATA_TYPE_OUT_RAW);
 	writel(val, pcsidev->csr_regs + pdata->if_ctrl_reg);
 
 	/* Enable sync Force */
@@ -989,7 +992,7 @@ static const struct mxc_pcsi_plat_data imx93_pdata = {
 	.def_hsync_pol		= 0,
 	.def_vsync_pol		= 0,
 	.def_pixel_clk_pol	= 0,
-	.def_csi_in_data_type	= CSI_IN_DT_YVYU_8,
+	.def_csi_in_data_type	= CSI_IN_DT_RAW_10,
 	.pd_ops			= NULL,
 };
 
-- 
2.46.0

